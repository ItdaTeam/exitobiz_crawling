<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="co.kr.exitobiz.Mappers.WebApp.UserMapper">

<select id="getUserToken" parameterType="hashMap" resultType="String">
SELECT usertoken
  FROM itda_app.usertable
WHERE id=#{id}
</select>


  <select id="getUserTokenByLocation" parameterType="hashMap" resultType="map">
    SELECT usertoken
    FROM itda_app.usertable u 
     left outer join itda_app.user_push_setting ups on u.id = ups.user_id
    WHERE usertoken not in ('', 'null')
      AND coalesce(ups.sp_receive_push, '')  != 'N'
          <if test="userlocs != null">
              AND userloc in
              <foreach collection="userlocs" item="loc" index="idx" separator="," open="(" close=")">
                  #{loc}
              </foreach>
          </if>
  </select>

  <select id="getUserTokenByKeyId" parameterType="hashMap" resultType="String">
    SELECT usertoken
    FROM itda_app.usertable u 
     left outer join itda_app.user_push_setting ups on u.id = ups.user_id
     left outer join itda_app.admin_push_setting aps on u.id = aps.user_id
     left outer join itda_app.chatrooms_one_push_setting cops on u.id = cops.user_id
    WHERE 1=1
      and u.id=#{id}
      and u.usertoken not in ('', 'null')
    <choose>
       <when test="keyId == 1 ">
          and coalesce(ups.sp_receive_push,'') != 'N'
          <if test="userlocs != null">
              AND userloc in
              <foreach collection="userlocs" item="loc" index="idx" separator="," open="(" close=")">
                  #{loc}
              </foreach>
          </if>
       </when>
       <when test="keyId == 2 ">
          and coalesce(ups.sp_keyword_push,'') != 'N'
       </when>
       <when test="keyId == 3 ">
          and coalesce(ups.sp_recomment_push,'') != 'N'
       </when>
       <when test="keyId == 4 ">
          and coalesce(ups.sp_commentlike_push,'') != 'N'
       </when>
        <when test="keyId == 5 ">
            and coalesce(ups.sp_bookmark_push,'') != 'N'
        </when>
        <when test="keyId == 6 ">
            and coalesce(ups.sp_content_comment_push,'') != 'N'
        </when>
        <when test="keyId == 7 ">
            and coalesce(ups.sp_community_commentlike_push,'') != 'N'
        </when>
        <when test="keyId == 8 ">
            and coalesce(ups.sp_community_recomment_push,'') != 'N'
        </when>
        <when test="keyId == 12 ">
            and coalesce(aps.chat_push ,'') != 'N'
        </when>
        <when test="keyId == 13 ">
            and coalesce(cops.push_yn, true) != false
        </when>
    </choose>
  </select>
  <!-- 
     getUserTokenByLocation Original

      SELECT usertoken
    FROM itda_app.usertable
    WHERE usertoken not in ('', 'null')
      AND 
          <if test="userlocs != null">
              AND userloc in
              <foreach collection="userlocs" item="loc" index="idx" separator="," open="(" close=")">
                  #{loc}
              </foreach>
          </if>

  -->

    <select id="getUserTokenByLocationTest" parameterType="hashMap" resultType="map">
        SELECT usertoken, userloc
        FROM itda_app.usertable
        WHERE usertoken not in ('', 'null')
        AND username in ('권혁남', '전승희', '이소연', '김호준', '박준호', '최찬미', '김은영')
        AND admin_flag = 'Y'
        <if test="loc != null">
        AND userloc in
        <foreach collection="params" item="loc" index="idx" separator="," open="(" close=")">
            #{loc}
        </foreach>
        </if>
    </select>

    <select id="getUserTokens" resultType="map">
        SELECT usertoken
        FROM itda_app.usertable u
        WHERE 1=1
           AND u.usertoken not in ('', 'null')
--           AND username in ('강태욱', '권혁남')
    </select>

    <select id="getUserInfo" parameterType="map" resultType="map">
        SELECT  u.usernickname, u.useremail, u.id
        FROM itda_app.usertable u
        WHERE id=#{userid}
    </select>

    <select id = "getCompanyInfo" parameterType="map" resultType="map">
        SELECT  user_id, company_name, rep_name, support_target, start_period, loc_ctg, company_type, business_type, support_type, business_ctg, tech_ctg, to_char(cret_dt, 'yyyy-mm-dd') cret_dt, cret_id, to_char(updt_dt, 'yyyy-mm-dd') updt_dt, updt_id
        FROM itda_web.user_support
        WHERE 1=1
          AND user_id=#{userid}
    </select>

    <update id="updatePushSetting" parameterType="map">
        UPDATE itda_app.user_push_setting
        set
            <choose>
                <when test="spbookmarkpush != null">
                    sp_bookmark_push =#{spbookmarkpush}
                </when>
              <otherwise>
                  sp_bookmark_push ='N'
              </otherwise>
            </choose>
            <if test="spreceivepush != null">
                ,sp_receive_push =#{spreceivepush}
            </if>
            <if test="spkeywordpush != null">
                ,sp_keyword_push =#{spkeywordpush}
            </if>
            <if test="sprecommentpush != null">
                ,sp_recomment_push =#{sprecommentpush}
            </if>
            <if test="spcommentlikepush != null">
                ,sp_commentlike_push =#{spcommentlikepush}
            </if>
            <if test="spcontentcommentpush != null">
                ,sp_content_comment_push =#{spcontentcommentpush}
            </if>
            <if test="spcommunitycommentlikepush != null">
                ,sp_community_commentlike_push =#{spcommunitycommentlikepush}
            </if>
            <if test="spcommunityrecommentpush != null">
                ,sp_community_recomment_push =#{spcommunityrecommentpush}
            </if>
        WHERE 1=1
            AND user_id=#{userid}
    </update>
    <select id="getPushSetting" parameterType="map" resultType="map">
        SELECT user_id, sp_receive_push, sp_keyword_push, sp_recomment_push, sp_commentlike_push, sp_bookmark_push, sp_content_comment_push, sp_community_commentlike_push, sp_community_recomment_push
        FROM itda_app.user_push_setting
     WHERE 1=1
        AND user_id = #{userid}
    </select>

    <update id="withdraw" parameterType="map">
        UPDATE itda_app.usertable
            SET usernickname ='탈퇴회원'
              , idprofile = 'https://exitobiz.co.kr/img/profile/default3.png'
              , useragerange = '-'
              , usergender = '-'
              , useremail = '-'
              , username = '-'
              , usertitle = '-'
              , userhp = '-'
              , companyname = '-'
              , companytype = '-'
              , companyloc = '-'
              , admin_flag = 'N'
        WHERE 1=1
            AND id = #{userid}
    </update>

    <select id="checkNickname" parameterType="map" resultType="int">
        SELECT count(usernickname)
            FROM itda_app.usertable
        WHERE 1=1
            AND usernickname =#{usernickname}
    </select>

    <update id="updateUserInfo" parameterType="map">
        UPDATE itda_app.usertable
        SET
            usernickname = #{usernickname}
        <if test="useremail != null">
            ,useremail = #{useremail}
        </if>
        WHERE 1=1
            AND id=#{userid}
    </update>

</mapper>
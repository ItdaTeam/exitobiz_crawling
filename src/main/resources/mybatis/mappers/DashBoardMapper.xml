<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="co.kr.exitobiz.Mappers.Cms.DashBoardMapper">
    <select id="onloadBoard" resultType="DashBoardVo">
        select *
        from (
        select count(indexid) as totalCnt,
        Round(count(indexid) / (select count(indexid)::numeric from itda_app.usertable where to_char(cret_time, 'YYYY-MM-dd') != to_char(now(), 'YYYY-MM-dd')) -1 , 3) * 100 as totalPer
        from itda_app.usertable
        )a1,
        (
        select count(distinct userid) as inCnt,
               Round(count(distinct userid) / (select count(distinct userid)::numeric from itda_app.loginsaver where to_char(login_time, 'YYYY-MM-dd') = to_char((select current_date -1), 'YYYY-MM-dd')) -1 ,3) * 100 as inPer
        from itda_app.loginsaver
        where to_char(login_time, 'YYYY-MM-dd') = to_char(now(), 'YYYY-MM-dd')
        )a2,
        (
        select count(indexid) as joinCnt,
        Round(count(indexid) / (select count(indexid)::numeric from itda_app.usertable where to_char(cret_time, 'YYYY-MM-dd') = to_char((select current_date -1), 'YYYY-MM-dd')) -1 ,3) * 100 as joinPer
        from itda_app.usertable
        where to_char(cret_time, 'YYYY-MM-dd') = to_char(now(), 'YYYY-MM-dd')
        )a3,
        (
        select count(indexid) as inActiveCnt
        from itda_app.usertable
        where to_char(last_time, 'YYYY-MM-dd') > to_char((select current_date -60), 'YYYY-MM-dd')
        )a4,
        (
        select count(tl_cd) as clickCnt,
        Round(count(tl_cd) / (select count(tl_cd)::numeric from itda_app.time_line where to_char(tl_cret_dt, 'YYYY-MM-dd') = to_char((select current_date -1), 'YYYY-MM-dd')) -1 ,3) * 100 as clickPer
        from itda_app.time_line
        where to_char(tl_cret_dt, 'YYYY-MM-dd') = to_char(now(), 'YYYY-MM-dd')
        )a5,
        (
         select count(si_idx) as crawlingCnt,
                case (select count(si_idx)::numeric from itda_app.support_info where to_char(si_cret_dt, 'YYYY-MM-dd') = to_char((select current_date -1), 'YYYY-MM-dd')) when 0 THEN 0 else
                        Round(count(si_idx) / (select count(si_idx)::numeric from itda_app.support_info where to_char(si_cret_dt, 'YYYY-MM-dd') = to_char((select current_date -1), 'YYYY-MM-dd')) -1 ,3) * 100
                    end as crawlingPer
         from itda_app.support_info
         where to_char(si_cret_dt, 'YYYY-MM-dd') = to_char(now(), 'YYYY-MM-dd')
        )a6,
        (
        select count(si_idx) as activeCrawlingCnt
        from itda_app.support_info
        where to_char(si_cret_dt, 'YYYY-MM-dd') = to_char(now(), 'YYYY-MM-dd')
        and si_active_yn = 'Y'
        )a7,
        (
         select count(distinct userid) - (select count(distinct userid)::numeric from itda_app.loginsaver where to_char(login_time, 'YYYY-WW') = to_char((select current_date -7), 'YYYY-WW')) as lastWeekTotalCnt,
                (Round(count(distinct userid) / (select count(distinct userid)::numeric from itda_app.loginsaver where to_char(login_time, 'YYYY-WW') = to_char((select current_date -7), 'YYYY-WW')) , 3) * 100) - 100  as lastWeekTotalPer
         from itda_app.loginsaver
         where to_char(login_time, 'YYYY-WW') = to_char((select current_date), 'YYYY-WW')
        ) a8,
        (
         select count(tl_cd) - (select count(tl_cd)::numeric from itda_app.time_line where to_char(tl_cret_dt, 'YYYY-WW') = to_char((select current_date -7), 'YYYY-WW')) as lastWeekClickCnt,
                (Round(count(tl_cd) / (select count(tl_cd)::numeric from itda_app.time_line where to_char(tl_cret_dt, 'YYYY-WW') = to_char((select current_date -7), 'YYYY-WW')) ,3) * 100) - 100 as lastWeekClickPer
         from itda_app.time_line
         where to_char(tl_cret_dt, 'YYYY-WW') = to_char((select current_date), 'YYYY-WW')
        ) a9,
        (
         select count(distinct userid) - (select count(distinct userid)::numeric from itda_app.loginsaver where to_char(login_time, 'YYYY-WW') = to_char((select current_date -14), 'YYYY-WW')) as beforeLastWeekTotalCnt,
                (Round(count(distinct userid) / (select count(distinct userid)::numeric from itda_app.loginsaver where to_char(login_time, 'YYYY-WW') = to_char((select current_date -14), 'YYYY-WW')) , 3) * 100)  - 100 as beforeLastWeekTotalPer
         from itda_app.loginsaver
         where to_char(login_time, 'YYYY-WW') = to_char((select current_date), 'YYYY-WW')
        ) a10,
        (
         select count(tl_cd) - (select count(tl_cd)::numeric from itda_app.time_line where to_char(tl_cret_dt, 'YYYY-WW') = to_char((select current_date -14), 'YYYY-WW')) as beforeLastWeekClickCnt,
                (Round(count(tl_cd) / (select count(tl_cd)::numeric from itda_app.time_line where to_char(tl_cret_dt, 'YYYY-WW') = to_char((select current_date -14), 'YYYY-WW')) ,3) * 100) - 100 as beforeLastWeekClickPer
         from itda_app.time_line
         where to_char(tl_cret_dt, 'YYYY-WW') = to_char((select current_date), 'YYYY-WW')
        ) a11,
        (
         select count(distinct userid) - (select count(distinct userid)::numeric from itda_app.loginsaver where to_char(login_time, 'YYYY-MM') = to_char((select current_date - interval '1 month'), 'YYYY-MM')) as lastMonthTotalCnt,
                (Round(count(distinct userid) / (select count(distinct userid)::numeric from itda_app.loginsaver where to_char(login_time, 'YYYY-MM') = to_char((select current_date - interval '1 month'), 'YYYY-MM')) , 3) * 100) - 100  as lastMonthTotalPer
         from itda_app.loginsaver
         where to_char(login_time, 'YYYY-MM') = to_char((select current_date), 'YYYY-MM')
        ) a12,
        (
         select count(tl_cd) - (select count(tl_cd)::numeric from itda_app.time_line where to_char(tl_cret_dt, 'YYYY-MM') = to_char((select current_date - interval '1 month'), 'YYYY-MM')) as lastMonthClickCnt,
                (Round(count(tl_cd) / (select count(tl_cd)::numeric from itda_app.time_line where to_char(tl_cret_dt, 'YYYY-MM') = to_char((select current_date - interval '1 month'), 'YYYY-MM')) ,3) * 100) - 100 as lastMonthClickPer
         from itda_app.time_line
         where to_char(tl_cret_dt, 'YYYY-MM') = to_char((select current_date), 'YYYY-MM')
        ) a13,
        (
         select count(distinct userid) - (select count(distinct userid)::numeric from itda_app.loginsaver where to_char(login_time, 'YYYY-MM') = to_char((select current_date - interval '2 month'), 'YYYY-MM')) as beforeLastMonthTotalCnt,
                (Round(count(distinct userid) / (select count(distinct userid)::numeric from itda_app.loginsaver where to_char(login_time, 'YYYY-MM') = to_char((select current_date - interval '2 month'), 'YYYY-MM')) , 3) * 100) - 100  as beforeLastMonthTotalPer
         from itda_app.loginsaver
         where to_char(login_time, 'YYYY-MM') = to_char((select current_date), 'YYYY-MM')
        ) a14,
        (
        select count(tl_cd) - (select count(tl_cd)::numeric from itda_app.time_line where to_char(tl_cret_dt, 'YYYY-MM') = to_char((select current_date - interval '2 month'), 'YYYY-MM')) as beforeLastMonthClickCnt
        from itda_app.time_line
        where to_char(tl_cret_dt, 'YYYY-MM') = to_char((select current_date), 'YYYY-MM')
        ) a15,
        (
         select (Round(count(indexid) / (select goal from itda_web.goal where month = to_char((select current_date), 'MM')) , 3) * 100) as goal
         from itda_app.usertable
        ) a16
    </select>

  <select id="getDauChart" parameterType="HashMap" resultType="DashBoardVo">
    select t.dateE as date, u1.joinCnt as joinCnt, t.clickCnt as clickCnt, u2.totalCnt as totalCnt
    from
      (
      select to_char(tl_cret_dt, 'YYYY-MM-dd') as dateE, count(*) as clickCnt
      from itda_app.time_line
      where to_char(tl_cret_dt, 'YYYY-MM-dd') between #{fromDate} and #{toDate}
      group by to_char(tl_cret_dt, 'YYYY-MM-dd')
      ) t left join
      (
      select count(*) as joinCnt, to_char(cret_time, 'YYYY-MM-dd') as joindate
      from itda_app.usertable
      where to_char(cret_time, 'YYYY-MM-dd') between #{fromDate} and #{toDate}
      group by to_char(cret_time, 'YYYY-MM-dd')
      ) u1 on u1.joindate = t.dateE left join
      (
        select to_char(login_time, 'YYYY-MM-dd') as date, count(distinct userid) as totalCnt
        from itda_app.loginsaver
        where to_char(login_time, 'YYYY-MM-dd') between #{fromDate} and #{toDate}
        group by to_char(login_time, 'YYYY-MM-dd')
      ) u2 on u2.date = t.dateE
    group by t.dateE, u1.joinCnt, t.clickCnt, u2.totalCnt
  </select>

    <select id="getWauChart" parameterType="HashMap" resultType="DashBoardVo">
        select t.joindate as date, t.joinCnt as joinCnt, u1.clickCnt as clickCnt, u2.totalCnt as totalCnt
        from
        (
        select count(*) as joinCnt, to_char(cret_time, 'YYYY-WW') as joindate
        from itda_app.usertable
        where to_char(cret_time, 'YYYY-WW') between #{fromDate} and #{toDate}
        group by to_char(cret_time, 'YYYY-WW')
        ) t left join
        (
        select to_char(tl_cret_dt, 'YYYY-WW') as dateE, count(*) as clickCnt
        from itda_app.time_line
        where to_char(tl_cret_dt, 'YYYY-WW') between #{fromDate} and #{toDate}
        group by to_char(tl_cret_dt, 'YYYY-WW')
        ) u1 on t.joindate = u1.dateE left join
        (
        select to_char(login_time, 'YYYY-WW') as date, count(distinct userid) as totalCnt
        from itda_app.loginsaver
        where to_char(login_time, 'YYYY-WW') between #{fromDate} and #{toDate}
        group by to_char(login_time, 'YYYY-WW')
        ) u2 on u2.date = t.joindate
        group by u1.dateE, t.joinCnt, u1.clickCnt, u2.totalCnt, t.joindate
        order by date
    </select>

    <select id="getMauChart" parameterType="HashMap" resultType="DashBoardVo">
        select t.joindate as date, t.joinCnt as joinCnt, u1.clickCnt as clickCnt, u2.totalCnt as totalCnt
        from
            (
            select count(*) as joinCnt, to_char(cret_time, 'YYYY-MM') as joindate
            from itda_app.usertable
            where to_char(cret_time, 'YYYY-MM') between #{fromDate} and #{toDate}
            group by to_char(cret_time, 'YYYY-MM')
            ) t left join
            (
            select to_char(tl_cret_dt, 'YYYY-MM') as dateE, count(*) as clickCnt
            from itda_app.time_line
            where to_char(tl_cret_dt, 'YYYY-MM') between #{fromDate} and #{toDate}
            group by to_char(tl_cret_dt, 'YYYY-MM')
            ) u1 on t.joindate = u1.dateE left join
            (
            select to_char(login_time, 'YYYY-MM') as date, count(distinct userid) as totalCnt
            from itda_app.loginsaver
            where to_char(login_time, 'YYYY-MM') between #{fromDate} and #{toDate}
            group by to_char(login_time, 'YYYY-MM')
            ) u2 on u2.date = t.joindate
        group by u1.dateE, t.joinCnt, u1.clickCnt, u2.totalCnt, t.joindate
        order by date
    </select>

  <select id="getInTopUser" resultType="DashBoardVo">
    select a1.usernickname as usernickname, a1.clickCnt as clickCnt, a2.inCnt as inCnt
    from (
           select count(*) as clickCnt, u.usernickname
           from itda_app.time_line t
                  left join itda_app.usertable u on u.id = t.tl_cret_id
           where u.admin_flag != 'Y'
           group by u.id, u.usernickname
           order by clickCnt desc
         ) a1 left join
         (
           SELECT COUNT(*) as inCnt, u.usernickname, u.id
           FROM (SELECT DISTINCT to_char(tl_cret_dt,'YYYY-MM-dd') as dt, tl_cret_id FROM itda_app.time_line) t
                  left join itda_app.usertable u on u.id = t.tl_cret_id
           where u.admin_flag != 'Y'
           GROUP BY u.usernickname, u.id
           order by inCnt desc
         ) a2 on a1.usernickname = a2.usernickname
    group by a1.usernickname, a1.clickCnt, a2.inCnt
    order by a2.inCnt desc
      limit 5
  </select>

  <select id="getLowPageCnt" resultType="DashBoardVo">
    select  a1.supPage as supPage, a1.supCnt as supCnt, a2.proPage as proPage, a2.proCnt as proCnt
    from (
             select (ROW_NUMBER() OVER(order by count(*))) AS ROWNUM, tl_event as supPage, count(*) as supCnt
             from itda_app.time_line
             where tl_page_type = '지원사업'
                and tl_button_name != '대상버튼'
                and tl_button_name != '검색버튼'
                and tl_button_name != '화면초기화'
                and tl_button_name != '변경버튼'
                and tl_button_name != '지역버튼'
             group by tl_event
             order by supCnt asc
             limit 5
         ) a1 left join
         (
             select (ROW_NUMBER() OVER(order by count(*))) AS ROWNUM, tl_event as proPage, count(*) as proCnt
             from itda_app.time_line
             where tl_page_type = '공급기업'
             group by tl_event
             order by proCnt asc
             limit 5
         ) a2 on a1.ROWNUM = a2.ROWNUM
    group by supCnt, supPage, proPage, proCnt
  </select>

  <select id="getAccessUserList" parameterType="hashMap" resultType="DashBoardVo">
    select a1.usernickname as usernickname, a1.clickCnt as clickCnt, a2.inCnt as inCnt, a1.id as id, a1.lastloc, a1.last_time, a1.useremail
    from (
          select count(*) as clickCnt, u.usernickname, u.id, u.lastloc, u.last_time, u.useremail
          from itda_app.time_line t
          left join itda_app.usertable u on u.id = t.tl_cret_id
          where u.admin_flag != 'Y'
          and t.tl_cret_dt between #{fromDate}::timestamp and #{toDate}::timestamp
          group by u.id, u.usernickname, u.useremail
          order by clickCnt desc
    ) a1 left join
    (
          SELECT COUNT(*) as inCnt, u.usernickname, u.id
          FROM
               (SELECT DISTINCT to_char(tl_cret_dt,'YYYY-MM-dd') as dt, tl_cret_id
                FROM itda_app.time_line
                where tl_cret_dt between #{fromDate}::timestamp and #{toDate}::timestamp
                ) t
          left join itda_app.usertable u on u.id = t.tl_cret_id
          where u.admin_flag != 'Y'
          GROUP BY u.usernickname, u.id
          order by inCnt desc
    ) a2 on a1.id = a2.id
    where 1=1
    <if test="inq != null">
      <choose>
        <when test="con == 'all'">
          AND
          <foreach collection="inq" item="item"
                   index="index" open="(" close=")" separator="or">
            a1.id LIKE '%' || #{item} || '%'
            or
            a1.usernickname LIKE '%' || #{item} || '%'
            or
            a1.lastloc LIKE '%' || #{item} || '%'
          </foreach>
        </when>
        <when test="con == 'id'">
          AND
          <foreach collection="inq" item="item"
                   index="index" open="(" close=")" separator="or">
            a1.id LIKE '%' || #{item} || '%'
          </foreach>
        </when>
        <when test="con == 'nickname'">
          AND
          <foreach collection="inq" item="item"
                   index="index" open="(" close=")" separator="or">
            a1.usernickname LIKE '%' || #{item} || '%'
          </foreach>
        </when>
        <when test="con == 'lastloc'">
          AND
          <foreach collection="inq" item="item"
                   index="index" open="(" close=")" separator="or">
            a1.lastloc LIKE '%' || #{item} || '%'
          </foreach>
        </when>
      </choose>
    </if>
    group by a1.usernickname, a1.clickCnt, a2.inCnt, a1.id, a1.lastloc, a1.last_time, a1.useremail
    order by a2.inCnt desc
  </select>

    <select id="getSupButton" parameterType="hashMap" resultType="DashBoardVo">
        select tl_event as supPage, count(*) as supCnt
        from itda_app.time_line
        where tl_page_type = '지원사업'
          and tl_button_name != '대상버튼'
          and tl_button_name != '검색버튼'
          and tl_button_name != '화면초기화'
          and tl_button_name != '변경버튼'
          and tl_button_name != '지역버튼'
          and tl_button_name != '웹뷰새로고침버튼'
          and tl_button_name != '웹뷰Back버튼'
        group by tl_event
        order by supCnt asc
    </select>

    <select id="getProButton" parameterType="hashMap" resultType="DashBoardVo">
        select tl_event as proPage, count(*) as proCnt
        from itda_app.time_line
        where tl_page_type = '공급기업'
        and tl_cret_dt between #{fromDate}::timestamp and #{toDate}::timestamp
        group by tl_event
        order by proCnt asc
    </select>

    <select id="getGoal" resultType="DashBoardVo">
        select month, goal, index
        from itda_web.goal
        order by index
    </select>

    <update id="updateGoal" parameterType="DashBoardVo">
        update itda_web.goal
        set goal = #{goal}::numeric
        where 1=1
        and index = #{month}::integer
    </update>

</mapper>